services:
  # ROS Melodic container with MoveIt and GPU support
  melodic:
    build:
      context: .
      dockerfile: melodic/Dockerfile_nvidia_melodic
    image: melodic_moveit:latest
    container_name: melodic
    command: /entrypoint.sh
    tty: true
    # CRITICAL: Required for GPU access and device permissions
    privileged: true
    volumes:
      # Mount project as subdirectory in catkin workspace  
      - "../:/catkin_ws/src/obj_manipulation"
      # X11 forwarding for GUI applications (RViz, etc.)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY}:/root/.Xauthority:rw
      # GPU device access for hardware acceleration
      - /dev/dri:/dev/dri
    environment:
      # X11 display configuration
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/root/.Xauthority
      # NVIDIA GPU configuration
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    # Use host networking for ROS communication
    network_mode: host
    # GPU resource allocation
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # ROS Noetic container with Python 3 support
  noetic:
    build:
      context: ..
      dockerfile: docker/noetic/Dockerfile_robot
    image: robot_noetic:latest
    container_name: noetic
    command: docker/entrypoint.sh
    tty: true
    # CRITICAL: Required for GPU access and device permissions
    privileged: true
    volumes:
      # Mount project as subdirectory in catkin workspace  
      - "../:/catkin_ws/src/obj_manipulation"
      # X11 forwarding for GUI applications (RViz, etc.)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY}:/root/.Xauthority:rw
      # GPU device access for hardware acceleration
      - /dev/dri:/dev/dri
    environment:
      # X11 display configuration
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/root/.Xauthority
      # NVIDIA GPU configuration
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    # Use host networking for ROS communication
    network_mode: host
    # GPU resource allocation
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
